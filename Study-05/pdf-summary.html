<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF ë¬¸ì„œ ìš”ì•½ ì• í”Œë¦¬ì¼€ì´ì…˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .upload-area {
            background: white;
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area.drag-over {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .upload-area.processing {
            border-color: #28a745;
            background-color: #d4edda;
        }

        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .progress-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background-color: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: #6c757d;
        }

        .results-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            display: none;
        }

        .extracted-text {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .file-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .file-info h3 {
            margin-bottom: 10px;
            color: #0056b3;
        }

        .file-info p {
            margin-bottom: 5px;
        }

        .chunks-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
        }

        .chunk-item {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .chunk-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .chunk-preview {
            font-size: 12px;
            color: #6c757d;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PDF ë¬¸ì„œ ìš”ì•½ ì• í”Œë¦¬ì¼€ì´ì…˜</h1>
            <p>PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìš”ì•½í•˜ì„¸ìš”</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text">PDF íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
            <p style="color: #999; font-size: 14px;">ìµœëŒ€ íŒŒì¼ í¬ê¸°: 50MB</p>
            <input type="file" id="fileInput" class="file-input" accept=".pdf" />
            <button class="btn" id="selectFileBtn">íŒŒì¼ ì„ íƒ</button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">ì²˜ë¦¬ ì¤‘...</div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="file-info" id="fileInfo">
            <h3>íŒŒì¼ ì •ë³´</h3>
            <p><strong>íŒŒì¼ëª…:</strong> <span id="fileName"></span></p>
            <p><strong>íŒŒì¼ í¬ê¸°:</strong> <span id="fileSize"></span></p>
            <p><strong>í˜ì´ì§€ ìˆ˜:</strong> <span id="pageCount"></span></p>
        </div>

        <div class="results-container" id="resultsContainer">
            <h3>ì¶”ì¶œëœ í…ìŠ¤íŠ¸</h3>
            <div class="extracted-text" id="extractedText"></div>

            <div class="chunks-info" id="chunksInfo">
                <h4>AI API ì „ì†¡ìš© ì²­í¬</h4>
                <p>í…ìŠ¤íŠ¸ê°€ ê¸¸ì–´ì„œ ì—¬ëŸ¬ ì²­í¬ë¡œ ë¶„í• ë˜ì—ˆìŠµë‹ˆë‹¤:</p>
                <div id="chunksContainer"></div>
            </div>

            <button class="btn" id="processWithAI" style="margin-top: 15px;">AIë¡œ ìš”ì•½í•˜ê¸°</button>
        </div>
    </div>

    <!-- PDF.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        // PDF ìš”ì•½ ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”ì¸ í´ë˜ìŠ¤
        class PDFSummaryApp {
            constructor() {
                this.currentFile = null;
                this.extractedText = '';
                this.textChunks = [];
                this.maxChunkSize = 4000; // AI API í† í° ì œí•œ ê³ ë ¤
                this.maxFileSize = 50 * 1024 * 1024; // 50MB

                this.initializeElements();
                this.bindEvents();
                this.initializePDFJS();
            }

            initializeElements() {
                this.uploadArea = document.getElementById('uploadArea');
                this.fileInput = document.getElementById('fileInput');
                this.selectFileBtn = document.getElementById('selectFileBtn');
                this.progressContainer = document.getElementById('progressContainer');
                this.progressFill = document.getElementById('progressFill');
                this.progressText = document.getElementById('progressText');
                this.errorMessage = document.getElementById('errorMessage');
                this.successMessage = document.getElementById('successMessage');
                this.fileInfo = document.getElementById('fileInfo');
                this.fileName = document.getElementById('fileName');
                this.fileSize = document.getElementById('fileSize');
                this.pageCount = document.getElementById('pageCount');
                this.resultsContainer = document.getElementById('resultsContainer');
                this.extractedText = document.getElementById('extractedText');
                this.chunksInfo = document.getElementById('chunksInfo');
                this.chunksContainer = document.getElementById('chunksContainer');
                this.processWithAI = document.getElementById('processWithAI');
            }

            initializePDFJS() {
                // PDF.js ì›Œì»¤ ì„¤ì •
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }

            bindEvents() {
                // íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­
                this.selectFileBtn.addEventListener('click', () => {
                    this.fileInput.click();
                });

                // íŒŒì¼ ì„ íƒ ì‹œ
                this.fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleFile(e.target.files[0]);
                    }
                });

                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
                this.uploadArea.addEventListener('click', () => {
                    this.fileInput.click();
                });

                this.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.add('drag-over');
                });

                this.uploadArea.addEventListener('dragleave', () => {
                    this.uploadArea.classList.remove('drag-over');
                });

                this.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.remove('drag-over');

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFile(files[0]);
                    }
                });

                // AI ì²˜ë¦¬ ë²„íŠ¼
                this.processWithAI.addEventListener('click', () => {
                    this.processWithAI();
                });
            }

            // íŒŒì¼ ìœ íš¨ì„± ê²€ì¦
            validateFile(file) {
                const errors = [];

                // PDF íŒŒì¼ í˜•ì‹ ê²€ì¦
                if (file.type !== 'application/pdf') {
                    errors.push('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }

                // íŒŒì¼ í¬ê¸° ê²€ì¦
                if (file.size > this.maxFileSize) {
                    errors.push(`íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ ${this.formatFileSize(this.maxFileSize)}ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                }

                // ë¹ˆ íŒŒì¼ ê²€ì¦
                if (file.size === 0) {
                    errors.push('ë¹ˆ íŒŒì¼ì€ ì—…ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                return errors;
            }

            // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                this.successMessage.style.display = 'none';
            }

            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            showSuccess(message) {
                this.successMessage.textContent = message;
                this.successMessage.style.display = 'block';
                this.errorMessage.style.display = 'none';
            }

            // ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            hideMessages() {
                this.errorMessage.style.display = 'none';
                this.successMessage.style.display = 'none';
            }

            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            updateProgress(percent, message) {
                this.progressFill.style.width = percent + '%';
                this.progressText.textContent = message;
            }

            // ì§„í–‰ë¥  í‘œì‹œ/ìˆ¨ê¸°ê¸°
            showProgress() {
                this.progressContainer.style.display = 'block';
                this.uploadArea.classList.add('processing');
            }

            hideProgress() {
                this.progressContainer.style.display = 'none';
                this.uploadArea.classList.remove('processing');
            }

            // íŒŒì¼ ì •ë³´ í‘œì‹œ
            showFileInfo(file, pageCount) {
                this.fileName.textContent = file.name;
                this.fileSize.textContent = this.formatFileSize(file.size);
                this.pageCount.textContent = pageCount;
                this.fileInfo.style.display = 'block';
            }

            // íŒŒì¼ ì²˜ë¦¬ ë©”ì¸ í•¨ìˆ˜
            async handleFile(file) {
                this.hideMessages();
                this.hideProgress();
                this.fileInfo.style.display = 'none';
                this.resultsContainer.style.display = 'none';

                // íŒŒì¼ ìœ íš¨ì„± ê²€ì¦
                const validationErrors = this.validateFile(file);
                if (validationErrors.length > 0) {
                    this.showError(validationErrors.join(' '));
                    return;
                }

                this.currentFile = file;
                this.showProgress();
                this.updateProgress(0, 'PDF íŒŒì¼ì„ ì½ëŠ” ì¤‘...');

                try {
                    // PDF íŒŒì¼ì„ ArrayBufferë¡œ ë³€í™˜
                    const arrayBuffer = await this.fileToArrayBuffer(file);
                    this.updateProgress(20, 'PDF ë¬¸ì„œë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...');

                    // PDF ë¬¸ì„œ ë¡œë“œ
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    this.updateProgress(40, 'í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ëŠ” ì¤‘...');

                    // íŒŒì¼ ì •ë³´ í‘œì‹œ
                    this.showFileInfo(file, pdf.numPages);

                    // í…ìŠ¤íŠ¸ ì¶”ì¶œ
                    const extractedText = await this.extractTextFromPDF(pdf);
                    this.updateProgress(80, 'í…ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘...');

                    // í…ìŠ¤íŠ¸ ì •ë¦¬ ë° ì²­í‚¹
                    const cleanedText = this.cleanText(extractedText);
                    this.textChunks = this.createTextChunks(cleanedText);

                    this.updateProgress(100, 'ì™„ë£Œ!');

                    // ê²°ê³¼ í‘œì‹œ
                    setTimeout(() => {
                        this.hideProgress();
                        this.displayResults(cleanedText);
                        this.showSuccess(`í…ìŠ¤íŠ¸ ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ${this.textChunks.length}ê°œì˜ ì²­í¬ë¡œ ë¶„í• ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }, 500);

                } catch (error) {
                    console.error('PDF ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                    this.hideProgress();
                    this.showError('PDF íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }

            // íŒŒì¼ì„ ArrayBufferë¡œ ë³€í™˜
            fileToArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'));
                    reader.readAsArrayBuffer(file);
                });
            }

            // PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            async extractTextFromPDF(pdf) {
                let fullText = '';
                const totalPages = pdf.numPages;

                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    try {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();

                        let pageText = '';
                        textContent.items.forEach(item => {
                            if (item.str) {
                                pageText += item.str + ' ';
                            }
                        });

                        if (pageText.trim()) {
                            fullText += `\n--- í˜ì´ì§€ ${pageNum} ---\n${pageText.trim()}\n`;
                        }

                        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                        const progress = 40 + (pageNum / totalPages) * 40;
                        this.updateProgress(progress, `í˜ì´ì§€ ${pageNum}/${totalPages} ì²˜ë¦¬ ì¤‘...`);

                        // ë©”ëª¨ë¦¬ ìµœì í™”ë¥¼ ìœ„í•´ ì ì‹œ ëŒ€ê¸°
                        if (pageNum % 10 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }

                    } catch (error) {
                        console.error(`í˜ì´ì§€ ${pageNum} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, error);
                        fullText += `\n--- í˜ì´ì§€ ${pageNum} (ì˜¤ë¥˜ ë°œìƒ) ---\n`;
                    }
                }

                return fullText;
            }

            // í…ìŠ¤íŠ¸ ì •ë¦¬
            cleanText(text) {
                return text
                    .replace(/\s+/g, ' ')  // ì—°ì†ëœ ê³µë°± ì œê±°
                    .replace(/\n\s*\n/g, '\n')  // ì—°ì†ëœ ë¹ˆ ì¤„ ì œê±°
                    .trim();
            }

            // í…ìŠ¤íŠ¸ë¥¼ ì²­í¬ë¡œ ë¶„í• 
            createTextChunks(text) {
                const chunks = [];
                const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);

                let currentChunk = '';

                for (const sentence of sentences) {
                    const trimmedSentence = sentence.trim();
                    if (!trimmedSentence) continue;

                    const potentialChunk = currentChunk + (currentChunk ? '. ' : '') + trimmedSentence;

                    if (potentialChunk.length <= this.maxChunkSize) {
                        currentChunk = potentialChunk;
                    } else {
                        if (currentChunk) {
                            chunks.push(currentChunk + '.');
                        }

                        // ë¬¸ì¥ ìì²´ê°€ ì²­í¬ í¬ê¸°ë¥¼ ì´ˆê³¼í•˜ëŠ” ê²½ìš° ê°•ì œ ë¶„í• 
                        if (trimmedSentence.length > this.maxChunkSize) {
                            const words = trimmedSentence.split(' ');
                            let wordChunk = '';

                            for (const word of words) {
                                if ((wordChunk + ' ' + word).length <= this.maxChunkSize) {
                                    wordChunk += (wordChunk ? ' ' : '') + word;
                                } else {
                                    if (wordChunk) {
                                        chunks.push(wordChunk);
                                    }
                                    wordChunk = word;
                                }
                            }

                            currentChunk = wordChunk;
                        } else {
                            currentChunk = trimmedSentence;
                        }
                    }
                }

                if (currentChunk) {
                    chunks.push(currentChunk + '.');
                }

                return chunks.map((chunk, index) => ({
                    id: index + 1,
                    text: chunk,
                    length: chunk.length
                }));
            }

            // ê²°ê³¼ í‘œì‹œ
            displayResults(text) {
                this.extractedText.textContent = text;
                this.displayChunks();
                this.resultsContainer.style.display = 'block';
            }

            // ì²­í¬ ì •ë³´ í‘œì‹œ
            displayChunks() {
                if (this.textChunks.length <= 1) {
                    this.chunksInfo.style.display = 'none';
                    return;
                }

                this.chunksContainer.innerHTML = '';

                this.textChunks.forEach(chunk => {
                    const chunkElement = document.createElement('div');
                    chunkElement.className = 'chunk-item';

                    const preview = chunk.text.length > 200 ?
                        chunk.text.substring(0, 200) + '...' :
                        chunk.text;

                    chunkElement.innerHTML = `
                        <div class="chunk-header">ì²­í¬ ${chunk.id} (${chunk.length}ì)</div>
                        <div class="chunk-preview">${preview}</div>
                    `;

                    this.chunksContainer.appendChild(chunkElement);
                });

                this.chunksInfo.style.display = 'block';
            }

            // AI API ì—°ë™ì„ ìœ„í•œ ë°ì´í„° ì¤€ë¹„
            prepareDataForAI() {
                return {
                    fileName: this.currentFile?.name,
                    fileSize: this.currentFile?.size,
                    totalChunks: this.textChunks.length,
                    chunks: this.textChunks,
                    fullText: this.extractedText.textContent,
                    metadata: {
                        timestamp: new Date().toISOString(),
                        processingTime: Date.now() - this.startTime
                    }
                };
            }

            // AI ì²˜ë¦¬ (ì—¬ê¸°ì„œëŠ” ë°ëª¨ìš©ìœ¼ë¡œ ì½˜ì†”ì— ì¶œë ¥)
            async processWithAI() {
                if (!this.textChunks.length) {
                    this.showError('ë¨¼ì € PDF íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const aiData = this.prepareDataForAI();

                // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì—¬ê¸°ì„œ AI APIë¥¼ í˜¸ì¶œ
                console.log('AI APIë¡œ ì „ì†¡í•  ë°ì´í„°:', aiData);

                this.showSuccess('AI ìš”ì•½ ìš”ì²­ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. (ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”)');

                // ì˜ˆì‹œ: ì‹¤ì œ AI API í˜¸ì¶œ
                /*
                try {
                    const response = await fetch('/api/summarize', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(aiData)
                    });

                    const result = await response.json();
                    // ê²°ê³¼ ì²˜ë¦¬
                } catch (error) {
                    this.showError('AI ìš”ì•½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
                */
            }

            // ë©”ëª¨ë¦¬ ì •ë¦¬
            cleanup() {
                this.currentFile = null;
                this.extractedText = '';
                this.textChunks = [];
            }
        }

        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            window.pdfApp = new PDFSummaryApp();
        });
    </script>
</body>
</html>